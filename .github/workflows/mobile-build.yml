name: Mobile Â· Build (Reusable)

on:
  workflow_call:
    inputs:
      tag:
        description: "Git tag to build (examples: v1.2.3 | v1.2.3-develop.4)"
        required: true
        type: string
      platform:
        description: "Target platform (android | ios | all)"
        required: true
        type: string
      eas-profile:
        description: "EAS build profile (dev | prod)"
        required: true
        type: string
    secrets:
      EXPO_TOKEN:
        required: true
      GPR_TOKEN:
        required: true
      GPR_USER:
        required: false

permissions:
  contents: read

env:
  CI: true
  WENDARA_APP_VARIANT: ${{ inputs.eas-profile }}

jobs:
  build:
    name: Build (${{ inputs.platform }}) Â· ${{ inputs.tag }} Â· ${{ inputs.eas-profile }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository at tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.tag }}

      - name: Validate inputs (tag format + prod policy)
        shell: bash
        run: |
          set -euo pipefail

          TAG="${{ inputs.tag }}"
          PROFILE="${{ inputs.eas-profile }}"

          # 1) Enforce tagFormat: v${version}
          if [[ ! "$TAG" =~ ^v[0-9]+(\.[0-9]+){2}([\-][0-9A-Za-z\.\-]+)?$ ]]; then
            echo "âŒ Invalid tag format: '$TAG'"
            echo "Expected examples:"
            echo " - v1.2.3"
            echo " - v1.2.3-develop.4"
            exit 1
          fi

          # 2) Prevent prod builds from prerelease tags (e.g., -develop.N)
          if [[ "$PROFILE" == "prod" && "$TAG" == *"-develop."* ]]; then
            echo "âŒ Policy violation: profile 'prod' cannot build prerelease tags."
            echo "Tag provided: '$TAG'"
            echo "Allowed examples for prod:"
            echo " - v1.2.3"
            echo "Not allowed for prod:"
            echo " - v1.2.3-develop.4"
            exit 1
          fi

          echo "âœ… Inputs OK. TAG='$TAG' PROFILE='$PROFILE'"

      - name: Validate tag exists
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force --quiet || true
          if ! git rev-parse -q --verify "refs/tags/${{ inputs.tag }}" >/dev/null; then
            echo "âŒ Tag '${{ inputs.tag }}' not found."
            echo "Available tags (latest 20):"
            git tag --sort=-creatordate | head -n 20 || true
            exit 1
          fi
          echo "âœ… Building tag '${{ inputs.tag }}'"

      - name: Set up Node (with npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: "22.14.0"
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Prepare npm userconfig for CI (GitHub Packages + npmjs)
        shell: bash
        run: |
          set -euo pipefail
          echo "registry=https://registry.npmjs.org/" > .npmrc.ci
          echo "@wendara-org:registry=https://npm.pkg.github.com" >> .npmrc.ci
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GPR_TOKEN }}" >> .npmrc.ci
          echo "âœ… .npmrc.ci configured (GitHub Packages + npmjs)"
          # Do not print tokenized file content.

      - name: Install dependencies
        run: npm ci
        env:
          NPM_CONFIG_USERCONFIG: ./.npmrc.ci

      - name: Verify build inputs
        shell: bash
        run: |
          set -euo pipefail
          echo "EAS_PROFILE=${{ inputs.eas-profile }}"
          echo "PLATFORM=${{ inputs.platform }}"
          echo "TAG=${{ inputs.tag }}"
          echo "WENDARA_APP_VARIANT=${WENDARA_APP_VARIANT}"
          echo "package.json version=$(node -p "require('./package.json').version")"

          if [ ! -f "eas.json" ]; then
            echo "âŒ eas.json not found at repo root."
            exit 1
          fi

      - name: Set up EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Build Android (EAS)
        id: build_android
        if: ${{ inputs.platform == 'android' || inputs.platform == 'all' }}
        shell: bash
        env:
          EAS_NO_VCS: 1
        run: |
          set -euo pipefail

          OUT="$(eas build --platform android --profile "${{ inputs.eas-profile }}" --non-interactive --wait --json)"
          echo "$OUT" > eas-android.json

          ID="$(echo "$OUT" | jq -r '.[0].id // empty')"
          DETAILS_URL="$(echo "$OUT" | jq -r '.[0].buildDetailsPageUrl // .[0].buildUrl // empty')"
          ARTIFACT_URL="$(echo "$OUT" | jq -r '.[0].artifacts.buildUrl // .[0].artifacts.applicationArchiveUrl // empty')"

          echo "id=${ID}" >> "$GITHUB_OUTPUT"
          echo "details_url=${DETAILS_URL}" >> "$GITHUB_OUTPUT"
          echo "artifact_url=${ARTIFACT_URL}" >> "$GITHUB_OUTPUT"

          echo "âœ… Android build:"
          echo "  id=${ID:-'(n/a)'}"
          echo "  details=${DETAILS_URL:-'(n/a)'}"
          echo "  artifact=${ARTIFACT_URL:-'(n/a)'}"

      - name: Build iOS (EAS)
        id: build_ios
        if: ${{ inputs.platform == 'ios' || inputs.platform == 'all' }}
        shell: bash
        env:
          EAS_NO_VCS: 1
        run: |
          set -euo pipefail

          OUT="$(eas build --platform ios --profile "${{ inputs.eas-profile }}" --non-interactive --wait --json)"
          echo "$OUT" > eas-ios.json

          ID="$(echo "$OUT" | jq -r '.[0].id // empty')"
          DETAILS_URL="$(echo "$OUT" | jq -r '.[0].buildDetailsPageUrl // .[0].buildUrl // empty')"
          ARTIFACT_URL="$(echo "$OUT" | jq -r '.[0].artifacts.buildUrl // .[0].artifacts.applicationArchiveUrl // empty')"

          echo "id=${ID}" >> "$GITHUB_OUTPUT"
          echo "details_url=${DETAILS_URL}" >> "$GITHUB_OUTPUT"
          echo "artifact_url=${ARTIFACT_URL}" >> "$GITHUB_OUTPUT"

          echo "âœ… iOS build:"
          echo "  id=${ID:-'(n/a)'}"
          echo "  details=${DETAILS_URL:-'(n/a)'}"
          echo "  artifact=${ARTIFACT_URL:-'(n/a)'}"

      - name: Upload EAS outputs (JSON)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eas-json-${{ inputs.tag }}-${{ inputs.platform }}-${{ inputs.eas-profile }}
          path: |
            eas-android.json
            eas-ios.json
          if-no-files-found: ignore

      - name: Build summary
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          # Fallback readers (if outputs are empty for any reason)
          android_details="${{ steps.build_android.outputs.details_url }}"
          android_artifact="${{ steps.build_android.outputs.artifact_url }}"
          android_id="${{ steps.build_android.outputs.id }}"

          ios_details="${{ steps.build_ios.outputs.details_url }}"
          ios_artifact="${{ steps.build_ios.outputs.artifact_url }}"
          ios_id="${{ steps.build_ios.outputs.id }}"

          if [ -z "${android_details:-}" ] && [ -f "eas-android.json" ]; then
            android_details="$(jq -r '.[0].buildDetailsPageUrl // .[0].buildUrl // empty' eas-android.json || true)"
          fi
          if [ -z "${android_artifact:-}" ] && [ -f "eas-android.json" ]; then
            android_artifact="$(jq -r '.[0].artifacts.buildUrl // .[0].artifacts.applicationArchiveUrl // empty' eas-android.json || true)"
          fi
          if [ -z "${android_id:-}" ] && [ -f "eas-android.json" ]; then
            android_id="$(jq -r '.[0].id // empty' eas-android.json || true)"
          fi

          if [ -z "${ios_details:-}" ] && [ -f "eas-ios.json" ]; then
            ios_details="$(jq -r '.[0].buildDetailsPageUrl // .[0].buildUrl // empty' eas-ios.json || true)"
          fi
          if [ -z "${ios_artifact:-}" ] && [ -f "eas-ios.json" ]; then
            ios_artifact="$(jq -r '.[0].artifacts.buildUrl // .[0].artifacts.applicationArchiveUrl // empty' eas-ios.json || true)"
          fi
          if [ -z "${ios_id:-}" ] && [ -f "eas-ios.json" ]; then
            ios_id="$(jq -r '.[0].id // empty' eas-ios.json || true)"
          fi

          {
            echo "## ðŸ“¦ Mobile Build Summary"
            echo ""
            echo "- **Tag:** \`${{ inputs.tag }}\`"
            echo "- **Platform:** \`${{ inputs.platform }}\`"
            echo "- **EAS profile:** \`${{ inputs.eas-profile }}\`"
            echo "- **Variant:** \`${WENDARA_APP_VARIANT}\`"
            echo ""

            if [ "${{ inputs.platform }}" = "android" ] || [ "${{ inputs.platform }}" = "all" ]; then
              echo "### ðŸ¤– Android"
              echo "- **EAS build page:** ${android_details:-'(not available)'}"
              echo "- **Direct download (APK/AAB):** ${android_artifact:-'(not available â€” use the EAS build page)'}"
              echo "- **Build id:** \`${android_id:-'(n/a)'}\`"
              echo ""
            fi

            if [ "${{ inputs.platform }}" = "ios" ] || [ "${{ inputs.platform }}" = "all" ]; then
              echo "### ðŸ iOS"
              echo "- **EAS build page:** ${ios_details:-'(not available)'}"
              echo "- **Direct download (IPA):** ${ios_artifact:-'(not available â€” use the EAS build page)'}"
              echo "- **Build id:** \`${ios_id:-'(n/a)'}\`"
              echo ""
            fi

            echo "Artifacts are generated in EAS. If direct download is missing, open the EAS build page and download from there."
          } >> "$GITHUB_STEP_SUMMARY"
